<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Modèle objet-relationel - Cours bases de données</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Mod\u00e8le objet-relationel";
        var mkdocs_page_input_path = "5. SQL Avanc\u00e9/03-objet-relationel.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Cours bases de données
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Cours de bases de données</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">1. Introduction</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../1.%20Introduction/01-Introduction-aux-bd/">Qu'est-ce qu'une base de données ?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../1.%20Introduction/02-Types-de-bases-de-donnees/">Types de bases de données</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../1.%20Introduction/03-Historique-des-bases-de-donnees/">Historique des bases de données</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../1.%20Introduction/04-Exemples-de-Bases-de-Donnees/">Exemples de Bases de Données dans Différents Contextes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >PostgreSQL</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../1.%20Introduction/PostgreSQL/01-Intro-a-PostgreSQL/">Introduction à PostgreSQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../1.%20Introduction/PostgreSQL/02-Avantages-de-PostgreSQL/">Avantages de PostgreSQL par rapport à d'autres SGBD</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../1.%20Introduction/PostgreSQL/03-Entreprises-utilisant-PostgreSQL/">Entreprises utilisant PostgreSQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../1.%20Introduction/PostgreSQL/04-Configuration/">Configuration de PostgreSQL</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">2. Le modèle relationnel</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../2.%20Le%20mod%C3%A8le%20relationnel/01-Pr%C3%A9sentation/">Présentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../2.%20Le%20mod%C3%A8le%20relationnel/02-DEA/">Introduction aux Diagrammes Entité-Association</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">3. SQL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/01-intro/">1 - Introduction à SQL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/02a-bases-contacts/">2a - Base de Données de Contacts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/02b-bases-universit%C3%A9/">2b - Base de Données Université</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/03a-jointures-contacts/">3a - Requêtes avec plus d'une table (Contacts)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/03b-jointures-universit%C3%A9/">3b - Requêtes avec plus d'une table (Université)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/04a-groupes-contacts/">4a - Groupement et Agrégats (Contacts)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/04b-groupes-universit%C3%A9/">4b - Groupement et Agrégats (Université)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/05-imbriqu%C3%A9es/">Requêtes SQL imbriquées</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../3.%20SQL/06-r%C3%A9cursives/">Requêtes récursives</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">4. Modélisation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../4.%20Mod%C3%A9lisation/01-mod%C3%A9lisation-EA/">Modélisation Entité-Association</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../4.%20Mod%C3%A9lisation/02-notation/">Différentes notations pour les DEA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../4.%20Mod%C3%A9lisation/03-exemples/">Exemples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../4.%20Mod%C3%A9lisation/04-ea-vers-relationnel/">Conversion d'un diagramme EA en schéma relationnel</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">5. SQL Avancé</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../01-vues/">Vues</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../02-contraintes-et-d%C3%A9clencheurs/">Contraintes et Déclencheurs</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Modèle objet-relationel</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#contacts-normalises">Contacts normalisés</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contacts1-schema-relationnel">contacts1 Schéma relationnel</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#que-devons-nous-faire-pour-permettre-a-un-utilisateur-davoir-plus-dun-contact">Que devons-nous faire pour permettre à un utilisateur d'avoir plus d'un contact ?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contacts2-schema-relationnel">contacts2 Schéma relationnel</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#jointure-necessaire-pour-obtenir-toutes-les-donnees">Jointure nécessaire pour obtenir toutes les données</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#contacts-denormalises">Contacts dénormalisés</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contacts3-schema-objet-relationnel">contacts3 Schéma objet-relationnel</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-avec-un-courriel-specifique-comme-premier-contact-durgence">Trouver les utilisateurs avec un courriel spécifique comme premier contact d'urgence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-un-utilisateur-avec-un-courriel-specifique-comme-contact-durgence-nimporte-quelle-position">Trouver un utilisateur avec un courriel spécifique comme contact d'urgence (n'importe quelle position)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-qui-sont-listes-comme-contact-durgence-dautres-utilisateurs">Trouver les utilisateurs qui sont listés comme contact d'urgence d'autres utilisateurs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sans-unnest-ni-sous-requetes">Sans unnest ni sous-requêtes</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#types-definis-par-les-utilisateurs">Types définis par les utilisateurs</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contacts4-schema-objet-relationnel">contacts4 Schéma objet-relationnel</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-tous-les-contacts-durgence-dun-utilisateur">Trouver tous les contacts d'urgence d'un utilisateur</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-sans-contacts-durgence">Trouver les utilisateurs sans contacts d'urgence</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#jsonb-a-la-place-de-tableaux">JSONB à la place de tableaux</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contacts5-schema-objet-relationnel">contacts5 Schéma objet-relationnel</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-avec-au-moins-un-contact-durgence">Trouver les utilisateurs avec au moins un contact d'urgence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-sans-contacts-durgence_1">Trouver les utilisateurs sans contacts d'urgence</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#schema-relationnel-avec-les-types-de-contact">Schéma relationnel avec les types de contact</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contacts6-relational-schema">contacts6 Relational Schema</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trouver-les-utilisateurs-sans-contacts-durgence_2">Trouver les utilisateurs sans contacts d'urgence</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#comment-traitons-nous-les-relations-plusieurs-a-plusieurs">Comment traitons-nous les relations plusieurs à plusieurs ?</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">6. Sécurité et Utilisateurs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../6.%20S%C3%A9curit%C3%A9%20et%20Utilisateurs/01-s%C3%A9curit%C3%A9/">Gestion des Utilisateurs et Sécurité</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../6.%20S%C3%A9curit%C3%A9%20et%20Utilisateurs/02-rbac/">Contrôle d'Accès Basé sur les Rôles (RBAC)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../6.%20S%C3%A9curit%C3%A9%20et%20Utilisateurs/03-utilisateurs/">Gestion des Utilisateurs dans PostgreSQL</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">7. Exercices</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../7.%20Exercices/01-exercices/">Exercices</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >DEA</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../7.%20Exercices/DEA/exercises_ER/">Exercises - Entity-Relationship Modeling</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >SQL</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../7.%20Exercices/SQL/01-pagila/">Base de données Pagila</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../7.%20Exercices/SQL/02-recettes/">Recettes de cuisine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../7.%20Exercices/SQL/03-northwind/">BD Northwind</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Cours bases de données</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">5. SQL Avancé</li>
      <li class="breadcrumb-item active">Modèle objet-relationel</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="modele-objet-relationel">Modèle objet-relationel</h1>
<p><em>ORDBMS</em> : Object-Relational DBMS</p>
<h2 id="contacts-normalises">Contacts normalisés</h2>
<h3 id="contacts1-schema-relationnel"><code>contacts1</code> Schéma relationnel</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts1 CASCADE;
CREATE SCHEMA contacts1;
SET search_path TO contacts1;

CREATE TABLE users
(
    uid               INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username          VARCHAR(15) NOT NULL,
    email             TEXT        NOT NULL,
    firstname         TEXT,
    lastname          TEXT,
    emergency_contact TEXT
);
</code></pre>
<pre><code class="language-sql">INSERT INTO users (username, email, emergency_contact)
VALUES ('denis', 'denis.rinfret@example.com', 'help@example.com'),
       ('minh', 'minh@example.com', 'contact@example.com');
</code></pre>
<pre><code class="language-sql">SELECT *
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
        <th>emergency_contact</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>help@example.com</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>contact@example.com</td>
    </tr>
</table>

<h3 id="que-devons-nous-faire-pour-permettre-a-un-utilisateur-davoir-plus-dun-contact">Que devons-nous faire pour permettre à un utilisateur d'avoir plus d'un contact ?</h3>
<ol>
<li>Si le nombre de contacts est fixe, disons <code>n</code> contacts, alors nous pourrions
   avoir <code>n</code> colonnes de contacts, tant que <code>n</code> est petit.</li>
<li>Mais si <code>n</code> n'est pas petit ou si <code>n</code> est inconnu, alors nous devons avoir
   une autre table, une table contacts, pour préserver la première forme
   normale.</li>
<li>La première forme normale stipule que chaque valeur de colonne doit être
   atomique.</li>
</ol>
<h3 id="contacts2-schema-relationnel"><code>contacts2</code> Schéma relationnel</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts2 CASCADE;
CREATE SCHEMA contacts2;
SET search_path TO contacts2;

CREATE TABLE users
(
    uid       INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username  VARCHAR(15) NOT NULL,
    email     TEXT        NOT NULL,
    firstname TEXT,
    lastname  TEXT
);

CREATE TABLE contacts
(
    cid   INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    email TEXT NOT NULL,
    uid   INTEGER REFERENCES users (uid)
)
</code></pre>
<pre><code class="language-sql"> INSERT INTO users (username, email)
 VALUES ('denis', 'denis.rinfret@example.com'),
        ('minh', 'minh@example.com');

INSERT INTO contacts (email, uid)
VALUES ('help@example.com', 1),
       ('minh@example.com', 1),
       ('contact@example.com', 2),
       ('ha@example.com', 2);

</code></pre>
<pre><code class="language-sql">SELECT *
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT *
FROM contacts;
</code></pre>
<table>
    <tr>
        <th>cid</th>
        <th>email</th>
        <th>uid</th>
    </tr>
    <tr>
        <td>1</td>
        <td>help@example.com</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh@example.com</td>
        <td>1</td>
    </tr>
    <tr>
        <td>3</td>
        <td>contact@example.com</td>
        <td>2</td>
    </tr>
    <tr>
        <td>4</td>
        <td>ha@example.com</td>
        <td>2</td>
    </tr>
</table>

<h3 id="jointure-necessaire-pour-obtenir-toutes-les-donnees">Jointure nécessaire pour obtenir toutes les données</h3>
<pre><code class="language-sql">SELECT *
FROM users u
         INNER JOIN contacts c ON u.uid = c.uid;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
        <th>cid</th>
        <th>email_1</th>
        <th>uid_1</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>1</td>
        <td>help@example.com</td>
        <td>1</td>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>2</td>
        <td>minh@example.com</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>3</td>
        <td>contact@example.com</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>4</td>
        <td>ha@example.com</td>
        <td>2</td>
    </tr>
</table>

<ol>
<li>Les jointures peuvent être lentes.</li>
<li>Mais sans normalisation, les données peuvent être redondantes et des
   anomalies peuvent apparaître.</li>
<li>Une SGDB <code>object-relationalle</code> (SGBDOR, ou ORDBMS) peut aider.</li>
</ol>
<h2 id="contacts-denormalises">Contacts dénormalisés</h2>
<h3 id="contacts3-schema-objet-relationnel"><code>contacts3</code> Schéma objet-relationnel</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts3 CASCADE;
CREATE SCHEMA contacts3;
SET search_path TO contacts3;

CREATE TABLE users
(
    uid                INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username           VARCHAR(15) NOT NULL,
    email              TEXT        NOT NULL,
    firstname          TEXT,
    lastname           TEXT,
    emergency_contacts TEXT[]
);
</code></pre>
<pre><code class="language-sql">INSERT INTO users (username, email, emergency_contacts)
VALUES ('denis', 'denis.rinfret@example.com',
        ARRAY ['help@example.com', 'minh@example.com']),
       ('minh', 'minh@example.com',
        ARRAY ['contact@example.com', 'ha@example.com']);
</code></pre>
<pre><code class="language-sql">SELECT uid, emergency_contacts
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>emergency_contacts</th>
    </tr>
    <tr>
        <td>1</td>
        <td>["help@example.com", "minh@example.com"]</td>
    </tr>
    <tr>
        <td>2</td>
        <td>["contact@example.com", "ha@example.com"]</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid,
       username,
       email,
       firstname,
       lastname,
       unnest(emergency_contacts)
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
        <th>unnest</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>help@example.com</td>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>minh@example.com</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>contact@example.com</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>ha@example.com</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-avec-un-courriel-specifique-comme-premier-contact-durgence">Trouver les utilisateurs avec un courriel spécifique comme premier contact d'urgence</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE emergency_contacts[1] = 'help@example.com';
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
    </tr>
</table>

<h3 id="trouver-un-utilisateur-avec-un-courriel-specifique-comme-contact-durgence-nimporte-quelle-position">Trouver un utilisateur avec un courriel spécifique comme contact d'urgence (n'importe quelle position)</h3>
<pre><code class="language-sql">
SELECT uid, username, email
FROM users
WHERE 'ha@example.com' = ANY (emergency_contacts);
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-qui-sont-listes-comme-contact-durgence-dautres-utilisateurs">Trouver les utilisateurs qui sont listés comme contact d'urgence d'autres utilisateurs</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE email IN (SELECT unnest(emergency_contacts)
                FROM users);
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT distinct uid, username, email
FROM users
         INNER JOIN
     (SELECT unnest(emergency_contacts) AS emergency_email
      FROM users) AS all_contacts
     ON email = emergency_email;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h3 id="sans-unnest-ni-sous-requetes">Sans <code>unnest</code> ni sous-requêtes</h3>
<pre><code class="language-sql">SELECT u1.uid, u1.username, u1.email
FROM users u1
         INNER JOIN users u2
                    ON u1.email = ANY (u2.emergency_contacts);
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h2 id="types-definis-par-les-utilisateurs">Types définis par les utilisateurs</h2>
<p>User-Defined Types (UDT)</p>
<h3 id="contacts4-schema-objet-relationnel"><code>contacts4</code> Schéma objet-relationnel</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts4 CASCADE;
CREATE SCHEMA contacts4;
SET search_path TO contacts4;

CREATE TYPE contact_type AS ENUM ('emergency', 'friend',
    'family', 'colleague');

CREATE TYPE contact AS
(
    email TEXT,
    type  contact_type
);
</code></pre>
<pre><code class="language-sql">CREATE TABLE users
(
    uid       INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username  VARCHAR(15) NOT NULL,
    email     TEXT        NOT NULL,
    firstname TEXT,
    lastname  TEXT,
    contacts  contact[]
);
</code></pre>
<pre><code class="language-sql">INSERT INTO users (username, email, contacts)
VALUES ('denis', 'denis.rinfret@example.com',
        ARRAY [('help@example.com', 'emergency')::contact,
            ('minh@example.com', 'friend')::contact]),
       ('minh', 'minh@example.com',
        ARRAY [('contact@example.com', 'family')::contact,
            ('ha@example.com', 'colleague')::contact]);
</code></pre>
<pre><code class="language-sql">SELECT uid, contacts
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>contacts</th>
    </tr>
    <tr>
        <td>1</td>
        <td>{&quot;(help@example.com,emergency)&quot;,&quot;(minh@example.com,friend)&quot;}</td>
    </tr>
    <tr>
        <td>2</td>
        <td>{&quot;(contact@example.com,family)&quot;,&quot;(ha@example.com,colleague)&quot;}</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid,
       username,
       email,
       (unnest(contacts)::contact).*
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>email_1</th>
        <th>type</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>help@example.com</td>
        <td>emergency</td>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>minh@example.com</td>
        <td>friend</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>contact@example.com</td>
        <td>family</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>ha@example.com</td>
        <td>colleague</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid,
       username,
       email,
       (unnest(contacts)::contact).email AS contact_email,
       (unnest(contacts)::contact).type  AS contact_type
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>contact_email</th>
        <th>contact_type</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>help@example.com</td>
        <td>emergency</td>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>minh@example.com</td>
        <td>friend</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>contact@example.com</td>
        <td>family</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>ha@example.com</td>
        <td>colleague</td>
    </tr>
</table>

<h3 id="trouver-tous-les-contacts-durgence-dun-utilisateur">Trouver tous les contacts d'urgence d'un utilisateur</h3>
<pre><code class="language-sql">SELECT *
FROM (SELECT uid,
             username,
             email,
             (unnest(contacts)::contact).email AS contact_email,
             (unnest(contacts)::contact).type  AS contact_type
      FROM users) AS temp
WHERE contact_type = 'emergency';
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>contact_email</th>
        <th>contact_type</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>help@example.com</td>
        <td>emergency</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-sans-contacts-durgence">Trouver les utilisateurs sans contacts d'urgence</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE 'emergency' NOT IN (SELECT (unnest(contacts)::contact).type);
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE 'emergency' != ALL (SELECT (unnest(contacts)::contact).type);
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h2 id="jsonb-a-la-place-de-tableaux">JSONB à la place de tableaux</h2>
<h3 id="contacts5-schema-objet-relationnel"><code>contacts5</code> Schéma objet-relationnel</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts5 CASCADE;
CREATE SCHEMA contacts5;
SET search_path TO contacts5;

CREATE TABLE users
(
    uid       INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username  VARCHAR(15) NOT NULL,
    email     TEXT        NOT NULL,
    firstname TEXT,
    lastname  TEXT,
    contacts  jsonb
);
</code></pre>
<pre><code class="language-sql">INSERT INTO users (username, email, contacts)
VALUES ('denis', 'denis.rinfret@example.com',
        '{&quot;emergency&quot;: &quot;help@example.com&quot;, &quot;friend&quot;: &quot;minh@example.com&quot;}'),
       ('minh', 'minh@example.com',
        '{&quot;family&quot;: &quot;contact@example.com&quot;, &quot;colleague&quot;: &quot;ha@example.com&quot;}');
</code></pre>
<pre><code class="language-sql">SELECT uid, contacts
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>contacts</th>
    </tr>
    <tr>
        <td>1</td>
        <td>{"friend": "minh@example.com", "emergency": "help@example.com"}</td>
    </tr>
    <tr>
        <td>2</td>
        <td>{"family": "contact@example.com", "colleague": "ha@example.com"}</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-avec-au-moins-un-contact-durgence">Trouver les utilisateurs avec au moins un contact d'urgence</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE 'emergency' IN (SELECT jsonb_object_keys(contacts));
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE contacts ? 'emergency';
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT uid, username, email, contacts -&gt; 'emergency' AS emergency
FROM users
WHERE contacts ? 'emergency';
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>emergency</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>help@example.com</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-sans-contacts-durgence_1">Trouver les utilisateurs sans contacts d'urgence</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE NOT (contacts ? 'emergency');
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h2 id="schema-relationnel-avec-les-types-de-contact">Schéma relationnel avec les types de contact</h2>
<h3 id="contacts6-relational-schema"><code>contacts6</code> Relational Schema</h3>
<pre><code class="language-sql">DROP SCHEMA IF EXISTS contacts6 CASCADE;
CREATE SCHEMA contacts6;
SET search_path TO contacts6;

CREATE TABLE users
(
    uid       INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username  VARCHAR(15) NOT NULL,
    email     TEXT        NOT NULL,
    firstname TEXT,
    lastname  TEXT
);
</code></pre>
<pre><code class="language-sql">CREATE TYPE contact_type AS ENUM ('emergency', 'friend',
    'family', 'colleague');

CREATE TABLE contacts
(
    cid   INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    email TEXT         NOT NULL,
    type  contact_type NOT NULL,
    uid   INTEGER REFERENCES users (uid)
);
</code></pre>
<pre><code class="language-sql">INSERT INTO users (username, email)
VALUES ('denis', 'denis.rinfret@example.com'),
       ('minh', 'minh@example.com');

INSERT INTO contacts (email, type, uid)
VALUES ('help@example.com', 'emergency', 1),
       ('minh@example.com', 'friend', 1),
       ('contact@example.com', 'colleague', 2),
       ('ha@example.com', 'family', 2);
</code></pre>
<pre><code class="language-sql">SELECT *
FROM users;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT *
FROM contacts;
</code></pre>
<table>
    <tr>
        <th>cid</th>
        <th>email</th>
        <th>type</th>
        <th>uid</th>
    </tr>
    <tr>
        <td>1</td>
        <td>help@example.com</td>
        <td>emergency</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh@example.com</td>
        <td>friend</td>
        <td>1</td>
    </tr>
    <tr>
        <td>3</td>
        <td>contact@example.com</td>
        <td>colleague</td>
        <td>2</td>
    </tr>
    <tr>
        <td>4</td>
        <td>ha@example.com</td>
        <td>family</td>
        <td>2</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT *
FROM users u
         INNER JOIN contacts c ON u.uid = c.uid;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
        <th>firstname</th>
        <th>lastname</th>
        <th>cid</th>
        <th>email_1</th>
        <th>type</th>
        <th>uid_1</th>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>1</td>
        <td>help@example.com</td>
        <td>emergency</td>
        <td>1</td>
    </tr>
    <tr>
        <td>1</td>
        <td>denis</td>
        <td>denis.rinfret@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>2</td>
        <td>minh@example.com</td>
        <td>friend</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>3</td>
        <td>contact@example.com</td>
        <td>colleague</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
        <td>None</td>
        <td>None</td>
        <td>4</td>
        <td>ha@example.com</td>
        <td>family</td>
        <td>2</td>
    </tr>
</table>

<h3 id="trouver-les-utilisateurs-sans-contacts-durgence_2">Trouver les utilisateurs sans contacts d'urgence</h3>
<pre><code class="language-sql">SELECT uid, username, email
FROM users
WHERE uid NOT IN (SELECT uid
                  FROM contacts
                  WHERE type = 'emergency');
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<pre><code class="language-sql">SELECT users.uid, username, email
FROM users
         LEFT JOIN (SELECT uid
                    FROM contacts
                    WHERE type = 'emergency') AS temp
                   ON users.uid = temp.uid
WHERE temp.uid IS NULL;
</code></pre>
<table>
    <tr>
        <th>uid</th>
        <th>username</th>
        <th>email</th>
    </tr>
    <tr>
        <td>2</td>
        <td>minh</td>
        <td>minh@example.com</td>
    </tr>
</table>

<h2 id="comment-traitons-nous-les-relations-plusieurs-a-plusieurs">Comment traitons-nous les relations plusieurs à plusieurs ?</h2>
<ul>
<li>Dans une base de données relationnelle, nous avons besoin d'une table
  supplémentaire entre les 2 tables.<ul>
<li>Par exemple, nous avons besoin d'une table entre "Users" et "Contacts",
  contenant des clés étrangères pour les ID d'utilisateur et les ID de
  contact.</li>
</ul>
</li>
<li>Comment récupérons-nous toutes les données ?<ul>
<li>Avec 2 jointures.</li>
</ul>
</li>
<li>Qu'en est-il des autres modèles de données ?<ul>
<li>Avec des tableaux ?</li>
<li>Avec JSONB ?</li>
</ul>
</li>
</ul>
<p><strong>Il n'y a pas de solutions miracles pour les relations plusieurs à plusieurs</strong></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../02-contraintes-et-d%C3%A9clencheurs/" class="btn btn-neutral float-left" title="Contraintes et Déclencheurs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../6.%20S%C3%A9curit%C3%A9%20et%20Utilisateurs/01-s%C3%A9curit%C3%A9/" class="btn btn-neutral float-right" title="Gestion des Utilisateurs et Sécurité">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../02-contraintes-et-d%C3%A9clencheurs/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../6.%20S%C3%A9curit%C3%A9%20et%20Utilisateurs/01-s%C3%A9curit%C3%A9/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
